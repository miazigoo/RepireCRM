
<div class="notifications-container">
  <button mat-icon-button
          [matMenuTriggerFor]="notificationsMenu"
          [matTooltip]="(connectionStatus$ | async) ? 'Уведомления' : 'Нет соединения'"
          [disabled]="!(connectionStatus$ | async)">
    <mat-icon [matBadge]="unreadCount$ | async"
              matBadgeColor="warn"
              [matBadgeHidden]="(unreadCount$ | async) === 0">
      notifications
    </mat-icon>
  </button>

  <mat-menu #notificationsMenu="matMenu" class="notifications-menu">
    <div class="notifications-header" (click)="$event.stopPropagation()">
      <h4>Уведомления</h4>
      <button mat-button
              *ngIf="(unreadCount$ | async)! > 0"
              (click)="markAllAsRead()"
              class="mark-all-read-btn">
        Прочитать все
      </button>
    </div>

    <mat-divider></mat-divider>

    <div class="notifications-list"
         *ngIf="(notifications$ | async)?.length! > 0; else noNotifications">

      <div *ngFor="let notification of (notifications$ | async)?.slice(0, 10)"
           class="notification-item"
           [class]="getPriorityClass(notification.priority)"
           (click)="onNotificationClick(notification)">

        <div class="notification-icon">
          <mat-icon [style.color]="notification.color">
            {{ notification.icon }}
          </mat-icon>
        </div>

        <div class="notification-content">
          <div class="notification-title">
            {{ notification.title }}
            <mat-icon class="priority-icon"
                      *ngIf="notification.priority !== 'normal'"
                      [matTooltip]="notification.priority">
              {{ getPriorityIcon(notification.priority) }}
            </mat-icon>
          </div>

          <div class="notification-message">
            {{ notification.message }}
          </div>

          <div class="notification-time">
            {{ getRelativeTime(notification.created_at) }}
          </div>
        </div>
      </div>
    </div>

    <ng-template #noNotifications>
      <div class="no-notifications">
        <mat-icon>notifications_none</mat-icon>
        <p>Нет новых уведомлений</p>
      </div>
    </ng-template>

    <mat-divider *ngIf="(notifications$ | async)?.length! > 0"></mat-divider>

    <div class="notifications-footer" (click)="$event.stopPropagation()">
      <button mat-button routerLink="/notifications" class="view-all-btn">
        Показать все уведомления
      </button>
    </div>
  </mat-menu>
</div>


<div class="connection-status"
     *ngIf="!(connectionStatus$ | async)"
     matTooltip="Нет соединения с сервером уведомлений">
  <mat-icon color="warn">wifi_off</mat-icon>
</div>
