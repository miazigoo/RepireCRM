
<div class="finance-dashboard">

  <div class="dashboard-header">
    <div class="header-content">
      <h1>Финансовый учет</h1>
      <p class="subtitle">Контроль доходов, расходов и денежных потоков</p>
    </div>

    <div class="header-actions">
      <form [formGroup]="filtersForm" class="period-selector">
        <mat-form-field appearance="outline">
          <mat-label>Период</mat-label>
          <mat-select formControlName="period">
            <mat-option value="7_days">7 дней</mat-option>
            <mat-option value="30_days">30 дней</mat-option>
            <mat-option value="90_days">3 месяца</mat-option>
            <mat-option value="custom">Произвольный</mat-option>
          </mat-select>
        </mat-form-field>
      </form>

      <button mat-raised-button color="primary" (click)="createExpense()">
        <mat-icon>receipt</mat-icon>
        Добавить расход
      </button>

      <button mat-raised-button (click)="exportFinancialReport()">
        <mat-icon>file_download</mat-icon>
        Отчет
      </button>
    </div>
  </div>


  <div class="financial-metrics" *ngIf="!loading">
    <div class="metrics-grid">
      <mat-card class="metric-card income-card">
        <mat-card-content>
          <div class="metric-header">
            <div class="metric-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="metric-trend positive">
              <mat-icon>arrow_upward</mat-icon>
            </div>
          </div>

          <div class="metric-content">
            <h3>{{ formatCurrency(summary.total_income) }}</h3>
            <p>Общий доход</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card expense-card">
        <mat-card-content>
          <div class="metric-header">
            <div class="metric-icon">
              <mat-icon>trending_down</mat-icon>
            </div>
            <div class="metric-trend negative">
              <mat-icon>arrow_downward</mat-icon>
            </div>
          </div>

          <div class="metric-content">
            <h3>{{ formatCurrency(summary.total_expenses) }}</h3>
            <p>Общие расходы</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card profit-card">
        <mat-card-content>
          <div class="metric-header">
            <div class="metric-icon">
              <mat-icon>account_balance</mat-icon>
            </div>
            <div class="metric-badge">
              {{ formatPercent(summary.profit_margin) }} маржа
            </div>
          </div>

          <div class="metric-content">
            <h3 [ngClass]="summary.net_profit >= 0 ? 'positive' : 'negative'">
              {{ formatCurrency(summary.net_profit) }}
            </h3>
            <p>Чистая прибыль</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card cash-card">
        <mat-card-content>
          <div class="metric-header">
            <div class="metric-icon">
              <mat-icon>account_balance_wallet</mat-icon>
            </div>
            <div class="metric-info" *ngIf="summary.pending_payments > 0">
              <small>{{ formatCurrency(summary.pending_payments) }} в ожидании</small>
            </div>
          </div>

          <div class="metric-content">
            <h3>{{ formatCurrency(summary.cash_balance) }}</h3>
            <p>Остаток в кассах</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>


  <div class="charts-section" *ngIf="!loading">
    <mat-tab-group class="finance-tabs">

      <mat-tab label="Динамика">
        <div class="chart-container">
          <mat-card>
            <mat-card-content>
              <div class="chart-wrapper" *ngIf="profitChartData">
                <canvas baseChart
                        [data]="profitChartData"
                        [options]="profitChartOptions"
                        type="line">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>


      <mat-tab label="Расходы">
        <div class="chart-container">
          <mat-card>
            <mat-card-content>
              <div class="chart-wrapper" *ngIf="expensesChartData">
                <canvas baseChart
                        [data]="expensesChartData"
                        [options]="expensesChartOptions"
                        type="doughnut">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>


      <mat-tab label="Транзакции">
        <div class="transactions-container">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Последние операции</mat-card-title>
              <div class="card-actions">
                <button mat-button routerLink="/finance/transactions">
                  Все транзакции
                </button>
              </div>
            </mat-card-header>

            <mat-card-content>
              <div class="table-container">
                <table mat-table [dataSource]="transactionDataSource" class="transactions-table">


                  <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef>Тип</th>
                    <td mat-cell *matCellDef="let transaction">
                      <div class="transaction-type" [ngClass]="getTransactionTypeClass(transaction.type)">
                        <mat-icon>{{ getTransactionTypeIcon(transaction.type) }}</mat-icon>
                      </div>
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="description">
                    <th mat-header-cell *matHeaderCellDef>Описание</th>
                    <td mat-cell *matCellDef="let transaction">
                      <div class="transaction-description">{{ transaction.description }}</div>
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="amount">
                    <th mat-header-cell *matHeaderCellDef>Сумма</th>
                    <td mat-cell *matCellDef="let transaction">
                      <div class="transaction-amount" [ngClass]="getTransactionTypeClass(transaction.type)">
                        {{ transaction.type === 'expense' ? '-' : '+' }}{{ formatCurrency(transaction.amount) }}
                      </div>
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="payment_method">
                    <th mat-header-cell *matHeaderCellDef>Способ оплаты</th>
                    <td mat-cell *matCellDef="let transaction">
                      <mat-chip class="payment-method-chip">{{ transaction.payment_method }}</mat-chip>
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Дата</th>
                    <td mat-cell *matCellDef="let transaction">
                      {{ transaction.date | date:'dd.MM.yyyy HH:mm' }}
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Статус</th>
                    <td mat-cell *matCellDef="let transaction">
                      <mat-chip [ngClass]="getStatusClass(transaction.status)">
                        {{ getStatusLabel(transaction.status) }}
                      </mat-chip>
                    </td>
                  </ng-container>


                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Действия</th>
                    <td mat-cell *matCellDef="let transaction">
                      <button mat-icon-button (click)="viewTransaction(transaction)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="transactionColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: transactionColumns;"></tr>
                </table>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>


  <div class="loading-container" *ngIf="loading">
    <mat-card>
      <mat-card-content>
        <div class="loading-content">
          <mat-icon class="loading-icon">account_balance</mat-icon>
          <p>Загрузка финансовых данных...</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
